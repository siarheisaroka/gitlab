stages:
  - testcode
  - build
  - test
  - push

variables:
  IMAGE_NAME: "djg"
  IMAGE_TAG: "0.01"

testcode:
  stage: testcode
  script:
    - cd 01_IntroductionToDevOps
    - PATH=/home/gitlab-runner/.local/bin:$PATH
    - flake8 --exclude=.venv --ignore=E501 .

build:
  stage: build
  script:
    - docker system prune -f
    - ls -al
    - cd 01_IntroductionToDevOps
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - mkdir -p build
    - ls -al
    - docker save $IMAGE_NAME:$IMAGE_TAG -o build/image.tar
    - ls -al build/
    - echo "registry name is $CI_REGISTRY_IMAGE" 
  artifacts:
    when: on_success
    paths:
      - 01_IntroductionToDevOps/build/
test:
  stage: test
  script:
      - cd 01_IntroductionToDevOps
      - docker system prune -f
      - docker-compose up -d
      - sleep 10
      - ss -ntpl
      - curl http://127.0.0.1:8000
  after_script:
    - echo "Execute this command after the `script` section completes."
    - cd 01_IntroductionToDevOps
    - ls -al
    - docker-compose down

      

save:
  stage: push
  script:
    - docker tag djg:0.01 myregistry/myapp:latest



